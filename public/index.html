<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8" />
	<title>WebSocket Mock æ§åˆ¶å°</title>
	<style>
		body {
			font-family: sans-serif;
			padding: 2em;
			background: #f9f9f9;
			max-width: 1000px;
			margin: auto;
		}

		.container {
			display: flex;
			gap: 2em;
			flex-wrap: wrap;
		}

		.panel {
			flex: 1 1 calc(50% - 4em);
			/* æ¯ä¸ªé¢æ¿å å¤§çº¦ 50% å®½åº¦ */
			background: #fff;
			padding: 1em;
			border-radius: 4px;
			box-shadow: 0 0 5px rgba(0, 0, 0, 0.1);
		}

		h1,
		h2 {
			margin-top: 0;
		}

		textarea {
			width: 100%;
			height: 120px;
			margin-bottom: 1em;
			font-family: monospace;
		}

		button {
			padding: 8px 16px;
			font-size: 16px;
			cursor: pointer;
			margin-bottom: 1em;
		}

		.log {
			white-space: pre-wrap;
			background: #eee;
			padding: 1em;
			height: 200px;
			overflow: auto;
			border-radius: 4px;
			font-family: monospace;
			font-size: 14px;
		}

		.ws-log {
			background: #222;
			color: #0f0;
		}
	</style>
</head>

<body>
	<h1>ğŸ§ª WebSocket Mock æ§åˆ¶å°</h1>
	<div class="container">
		<!-- å·¦ä¾§ï¼šPOST æ¨é€ & WS æ¥æ”¶ æ—¥å¿— -->
		<div class="panel">
			<h2>1. å‘é€ POST æ¶ˆæ¯å¹¿æ’­ç»™æ‰€æœ‰å®¢æˆ·ç«¯</h2>
			<textarea id="jsonInput">{ "message": "hello from web console", "source": "web-ui" }</textarea>
			<button onclick="sendHTTP()">å‘é€ POST</button>

			<h2>2. WebSocket æ¥æ”¶æ¶ˆæ¯æ—¥å¿—</h2>
			<div id="wsLog" class="log ws-log"></div>
		</div>

		<!-- å³ä¾§ï¼šå®¢æˆ·ç«¯ WS æµ‹è¯• åŒº -->
		<div class="panel">
			<h2>3. å®¢æˆ·ç«¯ WebSocket æµ‹è¯•</h2>
			<p>è¾“å…¥è¦å‘é€åˆ°æœåŠ¡å™¨çš„ JSONï¼š</p>
			<textarea id="wsInput">{ "type": "test", "content": "Hello Server" }</textarea>
			<button onclick="sendWS()">å‘é€ WS æ¶ˆæ¯</button>

			<h2>4. å®¢æˆ·ç«¯å‘é€/æ¥æ”¶æ—¥å¿—</h2>
			<div id="wsClientLog" class="log"></div>
		</div>
		<!-- SSE æ§åˆ¶é¢æ¿ -->
		<div class="panel">
			<h2>5. æœåŠ¡ç«¯å‘é€äº‹ä»¶ï¼ˆSSEï¼‰</h2>
			<p>SSE æ˜¯å•å‘æ¨é€ï¼Œç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å»ºç«‹è¿æ¥</p>
			<button onclick="startSSE()">å»ºç«‹ SSE è¿æ¥</button>
			<button onclick="stopSSE()">æ–­å¼€ SSE è¿æ¥</button>
			<div id="sseStatus">å½“å‰çŠ¶æ€ï¼šæœªè¿æ¥</div>

			<h2>6. SSE æ—¥å¿—</h2>
			<div id="sseLog" class="log"></div>

			<h2>7. å‘ SSE å®¢æˆ·ç«¯å¹¿æ’­æ¶ˆæ¯</h2>
			<textarea id="sseInput">{ "from": "client-ui", "content": "hello sse" }</textarea>
			<button onclick="sendSSEMessage()">å‘é€ SSE æ¶ˆæ¯</button>
		</div>

	</div>

	<script>
		// é€šç”¨æ—¥å¿—è¿½åŠ å‡½æ•°
		function appendLog(containerId, msg) {
			const div = document.getElementById(containerId);
			div.textContent += msg + '\n';
			div.scrollTop = div.scrollHeight;
		}

		// ==== 1. HTTP POST æ¨é€ ====
		async function sendHTTP() {
			const raw = document.getElementById('jsonInput').value;
			try {
				const payload = JSON.parse(raw);
				const res = await fetch('/push', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify(payload)
				});
				const result = await res.json();
				appendLog('wsLog', `[ğŸ“¤ POST å·²å‘é€] ${JSON.stringify(result)}`);
			} catch (err) {
				appendLog('wsLog', `[âŒ POST é”™è¯¯] ${err.message}`);
			}
		}

		// ==== 2. WebSocket å®¢æˆ·ç«¯ï¼ˆæ¥æ”¶éƒ¨åˆ†ï¼‰ ====
		const ws = new WebSocket(`ws://${location.host}/ws?token=test`);
		ws.addEventListener('open', () => {
			appendLog('wsLog', '[âœ… WS å·²è¿æ¥]');
		});
		ws.addEventListener('message', e => {
			appendLog('wsLog', `[ğŸ“¥ æ”¶åˆ°] ${e.data}`);
			appendLog('wsClientLog', `[ğŸ“¥ æ”¶åˆ°] ${e.data}`);
		});
		ws.addEventListener('close', () => {
			appendLog('wsLog', '[ğŸ”Œ WS å·²å…³é—­]');
			appendLog('wsClientLog', '[ğŸ”Œ WS å·²å…³é—­]');
		});
		ws.addEventListener('error', err => {
			appendLog('wsLog', `[â— WS é”™è¯¯] ${err.message}`);
			appendLog('wsClientLog', `[â— WS é”™è¯¯] ${err.message}`);
		});

		// ==== 3. å®¢æˆ·ç«¯å‘é€ WS æ¶ˆæ¯ ====
		function sendWS() {
			const raw = document.getElementById('wsInput').value;
			try {
				const payload = JSON.parse(raw);
				ws.send(JSON.stringify(payload));
				appendLog('wsClientLog', `[ğŸ“¤ å‘é€] ${JSON.stringify(payload)}`);
			} catch (err) {
				appendLog('wsClientLog', `[âŒ WS å‘é€é”™è¯¯] ${err.message}`);
			}
		}

	</script>
	<script>
		let sse = null;

		function startSSE() {
			if (sse) {
				appendLog('sseLog', '[âš ï¸ SSE å·²è¿æ¥ï¼Œæ— éœ€é‡å¤è¿æ¥]');
				return;
			}

			sse = new EventSource('/sse');
			document.getElementById('sseStatus').textContent = 'å½“å‰çŠ¶æ€ï¼šè¿æ¥ä¸­...';

			sse.addEventListener('connected', () => {
				appendLog('sseLog', '[âœ… SSE å·²è¿æ¥]');
				document.getElementById('sseStatus').textContent = 'å½“å‰çŠ¶æ€ï¼šå·²è¿æ¥';
			});

			sse.onmessage = e => {
				appendLog('sseLog', `[ğŸ“¥ SSE æ”¶åˆ°] ${e.data}`);
				appendLog('wsClientLog', `[ğŸ“¥ SSE æ”¶åˆ°] ${e.data}`);
			};

			sse.onerror = () => {
				appendLog('sseLog', '[âŒ SSE é”™è¯¯]');
				document.getElementById('sseStatus').textContent = 'å½“å‰çŠ¶æ€ï¼šè¿æ¥é”™è¯¯';
				sse.close();
				sse = null;
			};
		}
		function stopSSE() {
			if (sse) {
				sse.close();
				sse = null;
				appendLog('sseLog', '[ğŸ”Œ SSE å·²æ–­å¼€]');
				document.getElementById('sseStatus').textContent = 'å½“å‰çŠ¶æ€ï¼šæœªè¿æ¥';
			} else {
				appendLog('sseLog', '[âš ï¸ SSE æœªè¿æ¥]');
			}
		}
		function sendSSEMessage() {
			const raw = document.getElementById('sseInput').value;
			try {
				const payload = JSON.parse(raw);
				fetch('/sse-push', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify(payload)
				})
					.then(res => res.json())
					.then(result => {
						appendLog('sseLog', `[ğŸ“¤ SSE æ¨é€å·²å‘é€] ${JSON.stringify(result)}`);
					});
			} catch (err) {
				appendLog('sseLog', `[âŒ SSE æ¨é€é”™è¯¯] ${err.message}`);
			}
		}
	</script>
</body>

</html>